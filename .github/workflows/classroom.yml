# GitHub Classroom Autograding Configuration
# è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„ GitHub Actions workflow æ–‡ä»¶

name: Autograding Tests
on:
  push:
    branches: [main, master]
    paths:
      - 'my-maker-profile.md'
      - 'challenge-reflection.md'
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  ai-grading:
    name: AI Auto-Grading
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout student repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests PyYAML
      
      - name: Check required files
        run: |
          if [ ! -f "my-maker-profile.md" ]; then
            echo "âŒ Error: my-maker-profile.md not found"
            exit 1
          fi
          
          if [ ! -f "challenge-reflection.md" ]; then
            echo "âŒ Error: challenge-reflection.md not found"
            exit 1
          fi
          
          echo "âœ… Required files found"
      
      - name: Run AI grading
        env:
          AI_PROVIDER: ${{ secrets.AI_PROVIDER || 'zhipu' }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ZHIPU_API_KEY: ${{ secrets.ZHIPU_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Create grading script inline
          cat > grade.py << 'PYTHON_SCRIPT'
          import os
          import json
          import requests
          from pathlib import Path
          
          # Configuration
          AI_PROVIDER = os.environ.get("AI_PROVIDER", "zhipu")
          
          if AI_PROVIDER == "zhipu" and os.environ.get("ZHIPU_API_KEY"):
              ZHIPU_API_KEY = os.environ.get("ZHIPU_API_KEY")
              MODEL = "glm-4.6"
              print(f"ğŸ¤– Using æ™ºè°±AI {MODEL}")
          elif os.environ.get("OPENAI_API_KEY"):
              from openai import OpenAI
              client = OpenAI(api_key=os.environ.get("OPENAI_API_KEY"))
              MODEL = "gpt-4o"
              print(f"ğŸ¤– Using OpenAI {MODEL}")
          else:
              print("âŒ Error: No AI API key found")
              exit(1)
          
          # Read files
          def read_file(filepath):
              try:
                  if Path(filepath).exists():
                      with open(filepath, 'r', encoding='utf-8') as f:
                          return f.read()
                  return f"âŒ File not found: {filepath}"
              except Exception as e:
                  return f"âŒ Error: {str(e)}"
          
          maker_profile = read_file("my-maker-profile.md")
          challenge_reflection = read_file("challenge-reflection.md")
          
          print(f"ğŸ“ Files read: {len(maker_profile)} + {len(challenge_reflection)} chars")
          
          # Grading prompt
          prompt = f"""You are a Maker educator grading Day 1 assignment.
          
          Evaluate the student's work and provide:
          - Overall status: âœ… Complete or âš ï¸ Needs revision
          - Section-by-section checklist
          - What they did well (be specific and encouraging)
          - Gentle suggestions for improvement
          - Encouraging closing message
          
          Both English and Chinese feedback.
          
          Student's my-maker-profile.md:
          {maker_profile[:3000]}
          
          Student's challenge-reflection.md:
          {challenge_reflection[:3000]}
          """
          
          # Call AI API
          try:
              if AI_PROVIDER == "zhipu":
                  url = "https://open.bigmodel.cn/api/paas/v4/chat/completions"
                  headers = {
                      "Content-Type": "application/json",
                      "Authorization": f"Bearer {ZHIPU_API_KEY}"
                  }
                  payload = {
                      "model": MODEL,
                      "messages": [
                          {"role": "system", "content": "You are a warm Maker educator."},
                          {"role": "user", "content": prompt}
                      ],
                      "thinking": {"type": "enabled"},
                      "temperature": 0.7,
                      "max_tokens": 3000
                  }
                  response = requests.post(url, headers=headers, json=payload, timeout=120)
                  response.raise_for_status()
                  feedback = response.json()["choices"][0]["message"]["content"]
              else:
                  response = client.chat.completions.create(
                      model=MODEL,
                      messages=[
                          {"role": "system", "content": "You are a warm Maker educator."},
                          {"role": "user", "content": prompt}
                      ],
                      temperature=0.7,
                      max_tokens=2000
                  )
                  feedback = response.choices[0].message.content
              
              print("âœ… AI grading completed")
              
              # Save feedback
              full_feedback = f"""# ğŸ“ AI Grading Feedback | AIè¯„åˆ†åé¦ˆ
              
              > **Graded by**: AI Teaching Assistant ({MODEL})
              > **Provider**: {AI_PROVIDER.upper()}
              
              {feedback}
              
              ---
              
              *This is automated AI feedback. Your instructor may provide additional comments.*
              *è¿™æ˜¯AIè‡ªåŠ¨åé¦ˆã€‚è®²å¸ˆå¯èƒ½ä¼šæä¾›é¢å¤–è¯„è®ºã€‚*
              """
              
              with open("feedback.md", "w", encoding="utf-8") as f:
                  f.write(full_feedback)
              
              print("ğŸ’¾ Feedback saved")
              
          except Exception as e:
              print(f"âŒ Grading error: {str(e)}")
              with open("feedback.md", "w", encoding="utf-8") as f:
                  f.write(f"# âŒ AI Grading Error\n\n{str(e)}\n\nPlease contact your instructor.")
              exit(1)
          
          PYTHON_SCRIPT
          
          python grade.py
      
      - name: Post feedback as issue
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const feedback = fs.readFileSync('feedback.md', 'utf8');
            
            // Check if feedback issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['ai-grading', 'feedback']
            });
            
            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: feedback
              });
              console.log(`âœ… Updated issue #${issues.data[0].number}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ“ AI Grading Feedback | AIè¯„åˆ†åé¦ˆ',
                body: feedback,
                labels: ['ai-grading', 'feedback']
              });
              console.log(`âœ… Created issue #${issue.data.number}`);
            }

